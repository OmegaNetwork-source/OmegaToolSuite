<script>
let provider, signer;

async function connectWallet() {
  if (!window.ethereum) return alert("Install MetaMask");
  provider = new ethers.BrowserProvider(window.ethereum);
  const accounts = await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner(accounts[0]); // Avoid ENS resolution
  document.getElementById("walletAddress").innerText = accounts[0].slice(0, 6) + "..." + accounts[0].slice(-4);
  document.getElementById("walletBox").style.display = "flex";
}

function disconnectWallet() {
  provider = null;
  signer = null;
  document.getElementById("walletBox").style.display = "none";
}

function showTab(id) {
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.querySelector(`.tab[onclick="showTab('${id}')"]`).classList.add("active");
  document.getElementById(id).classList.add("active");
}

// TOKEN CREATION
const FACTORY_ADDRESS = "0x0f45dc8b06fdb019ece304fdf6e9e515a2b49cf3";
const FACTORY_ABI = ["function createToken(string name, string symbol, uint256 supply) public returns (address)"];

async function createToken() {
  const name = document.getElementById("name").value.trim();
  const symbol = document.getElementById("symbol").value.trim();
  const supply = document.getElementById("supply").value.trim();
  const status = document.getElementById("status");
  if (!name || !symbol || !supply) return alert("Fill in all fields");
  try {
    const factory = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, signer);
    const fullSupply = ethers.parseUnits(supply, 18);
    status.innerText = "Deploying...";
    const tx = await factory.createToken(name, symbol, fullSupply);
    const receipt = await tx.wait();
    const tokenAddr = receipt.logs?.[0]?.address;
    status.innerHTML = `✅ Token deployed: <code>${tokenAddr}</code>`;
  } catch (err) {
    console.error(err);
    status.innerText = "❌ " + (err.reason || err.message);
  }
}

// AIRDROP
const ERC20_ABI = [
  "function transfer(address to, uint amount) external returns (bool)",
  "function decimals() external view returns (uint8)"
];

async function sendAirdrop() {
  const tokenAddr = document.getElementById("airdropToken").value.trim();
  const status = document.getElementById("airdropStatus");
  const text = document.getElementById("manualAirdrop").value.trim();

  if (!tokenAddr) return alert("Enter token address");
  const token = new ethers.Contract(tokenAddr, ERC20_ABI, signer);
  const decimals = await token.decimals();
  const lines = text.split(/\n|,/).filter(l => l.trim()).map(l => l.trim());

  status.innerText = "Sending...";
  try {
    for (let i = 0; i < lines.length; i += 2) {
      const addr = lines[i];
      const amt = ethers.parseUnits(lines[i+1], decimals);
      const tx = await token.transfer(addr, amt);
      await tx.wait();
    }
    status.innerText = "✅ Airdrop sent";
  } catch (err) {
    console.error(err);
    status.innerText = "❌ Airdrop failed: " + (err.reason || err.message);
  }
}

window.onload = connectWallet;
</script>
</body>
</html>
